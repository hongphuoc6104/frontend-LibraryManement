<!-- /**
 * ---------------------------------------------------------------------------------------------
 * T√™n d·ª± √°n: Website Qu·∫£n l√Ω Th∆∞ vi·ªán Tr·ª±c tuy·∫øn
 * ---------------------------------------------------------------------------------------------
 * M√¥ t·∫£: File x√¢y d·ª±ng form ƒëƒÉng k√Ω 2 b∆∞·ªõc, b·∫Øt m·ªôt s·ªë l·ªói nh·∫≠p k√Ω t·ª±.
 *
 * @author  Nguy·ªÖn Nh·∫≠t H·ªìng Ph∆∞·ªõc
 * @mssv    B2308385
 * @date    27/07/2025
 *
 * @copyright (c) 2025 Nguy·ªÖn Nh·∫≠t H·ªìng Ph∆∞·ªõc. All rights reserved.
 * ---------------------------------------------------------------------------------------------
 */ -->
<template>
  <div class="w-full">
    <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-2">
      T·∫°o t√†i kho·∫£n m·ªõi
    </h2>
    <p class="text-center text-gray-600 mb-6">
      Ch·ªâ v·ªõi 2 b∆∞·ªõc ƒë∆°n gi·∫£n ƒë·ªÉ tham gia c·ªông ƒë·ªìng.
    </p>

    <div class="flex items-center justify-center mb-6">
      <div 
        class="flex items-center" 
        :class="step === 1 ? 'text-indigo-600' : 'text-green-500'"
      >
        <div class="rounded-full transition duration-500 ease-in-out h-8 w-8 flex items-center justify-center font-bold border-2"
             :class="step === 1 ? 'border-indigo-600' : 'border-green-500 bg-green-500 text-white'">
          1
        </div>
        <div class="ml-2 font-semibold">T√†i kho·∫£n</div>
      </div>
      <div class="flex-auto border-t-2 transition duration-500 ease-in-out mx-4"
           :class="step === 2 ? 'border-green-500' : 'border-gray-300'">
      </div>
      <div 
        class="flex items-center"
        :class="step === 2 ? 'text-indigo-600' : 'text-gray-500'"
      >
        <div class="rounded-full transition duration-500 ease-in-out h-8 w-8 flex items-center justify-center font-bold border-2"
             :class="step === 2 ? 'border-indigo-600' : 'border-gray-300'">
          2
        </div>
        <div class="ml-2 font-semibold">C√° nh√¢n</div>
      </div>
    </div>
    
    <form @submit.prevent="handleRegister" class="space-y-6">
      <div v-if="step === 1" class="space-y-6">
        <div>
          <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">Email <span class="text-red-500">*</span></label>
          <input v-model="email" type="email" id="email" required placeholder="V√≠ d·ª•: ban@example.com" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
          <p v-if="errorEmail" class="text-red-600 text-sm mt-1">{{ errorEmail }}</p>
        </div>
        <div>
          <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">M·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
          <input v-model="password" type="password" id="password" required placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
          <p v-if="errorPassword" class="text-red-600 text-sm mt-1">{{ errorPassword }}</p>
        </div>
        <div>
          <label for="confirm" class="block text-sm font-semibold text-gray-700 mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u <span class="text-red-500">*</span></label>
          <input v-model="confirm" type="password" id="confirm" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
          <p v-if="errorConfirm" class="text-red-600 text-sm mt-1">{{ errorConfirm }}</p>
        </div>
      </div>

      <div v-if="step === 2" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-6">
        <div>
          <label for="hoLot" class="block text-sm font-semibold text-gray-700 mb-2">H·ªç l√≥t <span class="text-red-500">*</span></label>
          <input v-model="hoLot" type="text" id="hoLot" required placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <p v-if="errorHoLot" class="text-red-600 text-sm mt-1">{{ errorHoLot }}</p>
        </div>
        <div>
          <label for="ten" class="block text-sm font-semibold text-gray-700 mb-2">T√™n <span class="text-red-500">*</span></label>
          <input v-model="ten" type="text" id="ten" required placeholder="V√≠ d·ª•: A" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <p v-if="errorTen" class="text-red-600 text-sm mt-1">{{ errorTen }}</p>
        </div>
        <div class="sm:col-span-2">
          <label for="ngaySinh" class="block text-sm font-semibold text-gray-700 mb-2">Ng√†y sinh</label>
          <input v-model="ngaySinh" type="date" id="ngaySinh" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="sm:col-span-2">
          <label for="diaChi" class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</label>
          <input v-model="diaChi" type="text" id="diaChi" placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="sm:col-span-2">
          <label for="dienThoai" class="block text-sm font-semibold text-gray-700 mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
          <input v-model="dienThoai" type="tel" id="dienThoai" placeholder="V√≠ d·ª•: 0901234567" class="w-full border border-gray-300 rounded-xl px-5 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
      </div>

      <div class="pt-6">
        <div v-if="step === 1" class="flex justify-end">
          <button @click="nextStep" type="button" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition transform hover:-translate-y-1">
            Ti·∫øp t·ª•c
          </button>
        </div>
        <div v-if="step === 2" class="flex flex-col sm:flex-row gap-4">
          <button @click="prevStep" type="button" class="w-full sm:w-1/3 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-300 transition">
            Quay l·∫°i
          </button>
          <button type="submit" class="w-full sm:w-2/3 bg-gray-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-gray-700 transition transform hover:-translate-y-1">
            ƒêƒÉng k√Ω t√†i kho·∫£n
          </button>
        </div>
      </div>

      <p v-if="message" :class="message.includes('th√†nh c√¥ng') ? 'text-green-600' : 'text-red-600'" class="text-center font-medium mt-4">
        {{ message }}
      </p>

      <p class="text-center text-sm text-gray-600 mt-6">
        ƒê√£ c√≥ t√†i kho·∫£n?
        <router-link to="/auth/login" class="text-indigo-600 font-semibold hover:underline">
          ƒêƒÉng nh·∫≠p ngay
        </router-link>
      </p>
    </form>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { useRouter } from 'vue-router';
import apiClient from '../services/apiService'

// State ƒë·ªÉ qu·∫£n l√Ω c√°c b∆∞·ªõc
const step = ref(1);

// Info c√° nh√¢n
const hoLot = ref('');
const ten = ref('');
const ngaySinh = ref('');
const diaChi = ref('');
const dienThoai = ref('');

// T√†i kho·∫£n
const email = ref('');
const password = ref('');
const confirm = ref('');
const message = ref('');

// C√°c bi·∫øn b√°o l·ªói
const errorHoLot = ref('');
const errorTen = ref('');
const errorEmail = ref('');
const errorPassword = ref('');
const errorConfirm = ref('');

const router = useRouter();

// H√†m ki·ªÉm tra l·ªói cho t·ª´ng b∆∞·ªõc
const validateStep1 = () => {
  errorEmail.value = '';
  errorPassword.value = '';
  errorConfirm.value = '';
  let hasError = false;

  if (!email.value) { errorEmail.value = 'Vui l√≤ng nh·∫≠p email.'; hasError = true; }
  else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) { errorEmail.value = 'Email kh√¥ng h·ª£p l·ªá.'; hasError = true; }
  
  if (!password.value) { errorPassword.value = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u.'; hasError = true; }
  else if (password.value.length < 6) { errorPassword.value = 'M·∫≠t kh·∫©u ph·∫£i t·ª´ 6 k√Ω t·ª±.'; hasError = true; }

  if (password.value !== confirm.value) { errorConfirm.value = 'M·∫≠t kh·∫©u kh√¥ng kh·ªõp.'; hasError = true; }

  return !hasError;
};

const validateStep2 = () => {
  errorHoLot.value = '';
  errorTen.value = '';
  let hasError = false;

  if (!hoLot.value) { errorHoLot.value = 'Vui l√≤ng nh·∫≠p h·ªç l√≥t.'; hasError = true; }
  if (!ten.value) { errorTen.value = 'Vui l√≤ng nh·∫≠p t√™n.'; hasError = true; }

  return !hasError;
};

// H√†m chuy·ªÉn b∆∞·ªõc
const nextStep = () => {
  if (validateStep1()) {
    step.value = 2;
  }
};

const prevStep = () => {
  step.value = 1;
};

// H√†m ƒëƒÉng k√Ω cu·ªëi c√πng
const handleRegister = async () => {
  if (step.value === 1) {
      if(validateStep1()) step.value = 2;
      return;
  }
  
  if (!validateStep2()) {
    message.value = 'Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng b·ªã l·ªói.';
    return;
  }
  
  message.value = 'ƒêang x·ª≠ l√Ω...';

  try {
    const userRes = await apiClient.post('/users', {
      hoLot: hoLot.value,
      ten: ten.value,
      ngaySinh: ngaySinh.value,
      diaChi: diaChi.value,
      dienThoai: dienThoai.value
    });

    const refId = userRes.data._id;

    await apiClient.post('/account/register', {
      email: email.value,
      password: password.value,
      role: 'user',
      refId,
      refModel: 'User'
    });

    message.value = 'T·∫°o t√†i kho·∫£n th√†nh c√¥ng üéâ';
    setTimeout(() => {
      router.push('/auth/login');
    }, 2000);
  } catch (err) {
    message.value = err.response?.data?.message || 'ƒê√£ c√≥ l·ªói x·∫£y ra khi ƒëƒÉng k√Ω.';
  }
};
</script>